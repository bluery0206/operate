{% extends 'home/base.html' %}
{% load custom_filters %}

{% block content %}
	<h2>Personnel Profiles</h2>

	<div class="personnel filter-bar">
		<!-- Search by text -->
		<form method="GET" class="search-form">
			<input class="form-control form-control-secondary" type="search" name="search" placeholder="Search by name" value="{% if filters.search %}{{ filters.search }}{% endif %}" title="Search">
			
			<!-- Keeping filter options because initiating a new search will reset the whole page -->
			<input type="hidden" name="designation" value="{{ filters.designation }}">
			<input type="hidden" name="rank" 		value="{{ filters.rank }}">
			<input type="hidden" name="sort_order" 	value="{{ filters.sort_order }}">
			<input type="hidden" name="sort_by" 	value="{{ filters.sort_by }}">
			<input type="hidden" name="sort_order" 	value="{{ filters.sort_order }}">

			<div class="actions">
				<button class="btn" type="submit" title="Search">
					<span class="material-symbols-outlined">search</span>
				</button>
				<button class="btn" type="submit" name="reset_search" title="Reset search" value="reset_search">
					<span class="material-symbols-outlined">search_off</span>
				</button>
			</div>
		</form>

		<!-- Filter -->
		<form method="GET" class="filter-form">

			<!-- keeping the search value in here to preserve it when resetting filters -->
			<input type="hidden" name="search" value="{{ filters.search }}">

			<input class="form-control form-control-secondary" type="search" name="designation" placeholder="Designation" value="{{ filters.designation }}">
			
			<select class="form-control form-control-secondary" name="rank" title="Filter by rank">
				<option class="option_title"  value="">Ranks</option>
				{% if ranks %}
					{% for rank in ranks%}
						<option value="{{ rank|lower }}" {% if filters.rank == rank %}selected{% endif %}>{{ rank|upper }}</option>
					{% endfor %}
				{% endif %}
			</select>
			
			<select class="form-control form-control-secondary" name="sort_by" title="Sort by">
				<option class="option_title" value="">Sort by</option>
				{% if sort_choices %}
					{% for pair in sort_choices %}
						<option class="option_title" value="{{ pair.0 }}" {% if pair.0 in filters.sort_by %}selected{% endif %}>{{ pair.1 }}</option>
					{% endfor %}
				{% endif %}
			</select>
			
			<select class="form-control form-control-secondary" name="sort_order" id="sort_order" title="Sort order">
				{% if order_choices %}
					{% for pair in order_choices %}
						<option class="option_title" value="{{ pair.0 }}" {% if pair.0 in filters.sort_order %}selected{% endif %}>{{ pair.1 }}</option>
					{% endfor %}
				{% endif %}
			</select>

			<button class="form-control form-control-secondary" type="submit" title="Apply filter">
				<span class="material-symbols-outlined">filter_alt</span>
			</button>
			
			<button class="form-control form-control-secondary" type="submit" name="reset_filter" title="Reset filter" value="reset_filter">
				<span class="material-symbols-outlined">filter_alt_off</span>
			</button>
		</form>

		<!-- Actions -->
		<div class="dropdown">
			<button class="btn btn-outline-light">
				<span class="material-symbols-outlined">more_vert</span>
			</button>

			<div class="content">
				<a class="btn" href="{% url 'profile-add' 'personnel' %}?prev={{request.path}}" title="Add new profile">
					<span class="material-symbols-outlined">add</span>
					<span>Add new profile</span>
				</a>
				<a class="btn" href="{% url 'archive-add-all' 'personnel' %}?prev={{request.path}}" title="Add all profiles to archive">
					<span class="material-symbols-outlined">archive</span>
					<span>Archive all</span>
				</a>
				<a class="btn btn-danger" href="{% url 'profile-delete-all' 'personnel' %}?prev={{request.path}}" title="Delete all profiles">
					<span class="material-symbols-outlined">delete</span>
					<span>Delete All</span>
				</a>
			</div>
		</div>
	</div>



	{% if is_paginated %}
		<div class="pagination left">
			<span class="page-list">
				{% if personnels.has_previous %}
					<a class="btn btn-outline-primary" href="?page=1">&laquo; First</a>
					<a class="btn btn-outline-primary" href="?page={{ personnels.previous_page_number }}">Previous</a>
				{% else %}
					<button class="btn btn-outline-secondary" disabled>&laquo; First</button>
					<button class="btn btn-outline-secondary" disabled>Previous</button>
				{% endif %}

				{% for num in personnels.paginator.page_range %}
					{% if personnels.number == num %}
						<a class="btn btn-primary" href="?page={{ num }}">{{ num }}</a>
					{% elif num > personnels.number|add:"-3" and num < personnels.number|add:"3" %}
						<a class="btn btn-outline-primary" href="?page={{ num }}">{{ num }}</a>
					{% endif %}
				{% endfor %}

				{% if personnels.has_next %}
					<a class="btn btn-outline-primary" href="?page={{ personnels.next_page_number }}">Next</a>
					<a class="btn btn-outline-primary" href="?page={{ personnels.paginator.num_pages }}">Last &raquo;</a>
				{% else %}
					<button class="btn btn-outline-secondary" disabled>Next</button>
					<button class="btn btn-outline-secondary" disabled>Last &raquo;</button>
				{% endif %}
			</span>
		</div>
	{% endif %}



	<div class="card-list">
		{% if personnels %}
			{% for profile in personnels %}
				<div class="card">
					<div class="picture">
						<div class="button-overlay">
							<a class="btn btn-transparent-primary" href="{% url 'profile' profile.p_type profile.pk %}" title="Open profile in detail">
								<span class="material-symbols-outlined">open_in_new</span>
								<span>View profile</span>
							</a>
							<a class="btn btn-transparent-secondary" href="{% url 'profile-update' profile.p_type profile.pk %}?prev={{request.get_full_path|urlencode }}" title="Edit profile">
								<span class="material-symbols-outlined">edit</span>
								<span>Edit profile</span>
							</a>
							<a class="btn btn-transparent-secondary" href="{% url 'archive-add' profile.p_type profile.pk %}?prev={{request.get_full_path|urlencode }}" title="Add profile to archives">
								<span class="material-symbols-outlined">archive</span>
								<span>Archive profile</span>
							</a>
							<a class="btn btn-transparent-danger" href="{% url 'profile-delete' profile.p_type profile.pk %}?prev={{request.get_full_path|urlencode }}" title="Add profile to archives">
								<span class="material-symbols-outlined">delete</span>
								<span>Delete Profile</span>
							</a>
						</div>

						<img src="{{ profile.thumbnail.url }}" alt="{{ profile|full_name }}'s profile picture">
					</div>

					<div class="details">
						<div class="name detail">{{ profile.rank|upper }} {{ profile|full_name }}</div>
						<div class="muted detail" title="{{ profile|full_name }}'s home address">
							<span>Address: {{ profile.address|title }}</span>
						</div>
						<div class="muted detail" title="{{ profile|full_name }}'s profiled date">
							<span>Profiled: {{ profile.date_profiled|date:"M j, Y" }}</span>
						</div>
						<div class="muted detail" title="{{ profile|full_name }}'s assigned date">
							<span>Assigned: {{ profile.date_assigned|date:"M j, Y" }}</span>
						</div>
						<div class="muted detail" title="{{ profile|full_name }}'s relieved date">
							<span>Relieved: {{ profile.date_relieved|date:"M j, Y" }}</span>
						</div>
						<div class="muted detail" title="{{ profile|full_name }}'s designation">
							<span>Designation: {{ profile.designation }}</span>
						</div>
					</div>
				</div>
			{% endfor %}
		{% else %}
			<h2>There are no personnel profiled.</h2>
		{% endif %}
	</div>



	{% if is_paginated %}
		<div class="pagination right">
			<span class="page-list">
				{% if personnels.has_previous %}
					<a class="btn btn-outline-primary" href="?page=1">&laquo; First</a>
					<a class="btn btn-outline-primary" href="?page={{ personnels.previous_page_number }}">Previous</a>
				{% else %}
					<button class="btn btn-outline-secondary" disabled>&laquo; First</button>
					<button class="btn btn-outline-secondary" disabled>Previous</button>
				{% endif %}

				{% for num in personnels.paginator.page_range %}
					{% if personnels.number == num %}
						<a class="btn btn-primary" href="?page={{ num }}">{{ num }}</a>
					{% elif num > personnels.number|add:"-3" and num < personnels.number|add:"3" %}
						<a class="btn btn-outline-primary" href="?page={{ num }}">{{ num }}</a>
					{% endif %}
				{% endfor %}

				{% if personnels.has_next %}
					<a class="btn btn-outline-primary" href="?page={{ personnels.next_page_number }}">Next</a>
					<a class="btn btn-outline-primary" href="?page={{ personnels.paginator.num_pages }}">Last &raquo;</a>
				{% else %}
					<button class="btn btn-outline-secondary" disabled>Next</button>
					<button class="btn btn-outline-secondary" disabled>Last &raquo;</button>
				{% endif %}
			</span>
		</div>
	{% endif %}
	
{% endblock content %}